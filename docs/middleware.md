# ä¸­é—´ä»¶ä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

æœ¬é¡¹ç›®ä½¿ç”¨ Next.js ä¸­é—´ä»¶æ¥å¤„ç†ç”¨æˆ·è®¤è¯å’Œä¼šè¯ç®¡ç†ã€‚ä¸­é—´ä»¶åœ¨è¯·æ±‚åˆ°è¾¾é¡µé¢ç»„ä»¶ä¹‹å‰æ‰§è¡Œï¼Œå¯ä»¥ï¼š

- éªŒè¯ç”¨æˆ·èº«ä»½
- æ³¨å…¥ç”¨æˆ·ä¿¡æ¯åˆ°è¯·æ±‚å¤´
- é‡å®šå‘æœªè®¤è¯ç”¨æˆ·
- è®°å½•è¯·æ±‚æ—¥å¿—

## åŠŸèƒ½ç‰¹æ€§

### ğŸ” å¤šæ–¹å¼è®¤è¯æ”¯æŒ
- **Cookie è®¤è¯**: å…¼å®¹ SSRï¼Œæ”¯æŒ `session` cookie
- **Header è®¤è¯**: æ”¯æŒ `Authorization: Bearer <token>` å’Œ `x-auth-token` header
- **è‡ªåŠ¨é™çº§**: ä¼˜å…ˆä½¿ç”¨ cookieï¼Œå¤±è´¥æ—¶å°è¯• header

### ğŸ›¡ï¸ çµæ´»çš„è·¯å¾„ä¿æŠ¤
- **æ’é™¤è·¯å¾„**: é™æ€èµ„æºã€API è·¯ç”±ç­‰ä¸éœ€è¦è®¤è¯
- **ä¿æŠ¤è·¯å¾„**: æŒ‡å®šéœ€è¦è®¤è¯çš„è·¯å¾„
- **æ™ºèƒ½é‡å®šå‘**: å¯é…ç½®è‡ªåŠ¨é‡å®šå‘åˆ°ç™»å½•é¡µ

### ğŸ“Š è¯¦ç»†çš„æ—¥å¿—è®°å½•
- **å¼€å‘ç¯å¢ƒ**: è‡ªåŠ¨å¯ç”¨è¯¦ç»†æ—¥å¿—
- **ç”Ÿäº§ç¯å¢ƒ**: å¯é…ç½®æ—¥å¿—çº§åˆ«
- **ç»“æ„åŒ–æ—¥å¿—**: åŒ…å«æ—¶é—´æˆ³å’Œä¸Šä¸‹æ–‡ä¿¡æ¯

### âš™ï¸ å¯é…ç½®é€‰é¡¹
- æ”¯æŒç¯å¢ƒå˜é‡é…ç½®
- è¿è¡Œæ—¶åŠ¨æ€è°ƒæ•´
- ç±»å‹å®‰å…¨çš„é…ç½®æ¥å£

## é…ç½®é€‰é¡¹

### ç¯å¢ƒå˜é‡

| å˜é‡å | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|------|
| `MIDDLEWARE_LOG_LEVEL` | `"info"` | æ—¥å¿—çº§åˆ« (debug/info/warn/error) |
| `MIDDLEWARE_REDIRECT_TO_LOGIN` | `"false"` | æ˜¯å¦è‡ªåŠ¨é‡å®šå‘åˆ°ç™»å½•é¡µ |
| `MIDDLEWARE_LOGIN_PATH` | `"/login"` | ç™»å½•é¡µé¢è·¯å¾„ |
| `SESSION_COOKIE_NAME` | `"session"` | ä¼šè¯ cookie åç§° |
| `MIDDLEWARE_ENABLE_CACHE` | `"false"` | æ˜¯å¦å¯ç”¨ç¼“å­˜ |
| `MIDDLEWARE_CACHE_TIMEOUT` | `"300000"` | ç¼“å­˜è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ |

### é»˜è®¤æ’é™¤è·¯å¾„

ä»¥ä¸‹è·¯å¾„é»˜è®¤ä¸ç»è¿‡ä¸­é—´ä»¶å¤„ç†ï¼š

- `/api` - API è·¯ç”±
- `/static` - é™æ€èµ„æº
- `/favicon.ico` - ç½‘ç«™å›¾æ ‡
- `/_next` - Next.js å†…éƒ¨æ–‡ä»¶
- `/_vercel` - Vercel éƒ¨ç½²ç›¸å…³
- `/robots.txt` - æœç´¢å¼•æ“çˆ¬è™«æ–‡ä»¶
- `/sitemap.xml` - ç½‘ç«™åœ°å›¾
- `/health` - å¥åº·æ£€æŸ¥
- `/ping` - è¿é€šæ€§æ£€æŸ¥

### é»˜è®¤ä¿æŠ¤è·¯å¾„

ä»¥ä¸‹è·¯å¾„é»˜è®¤éœ€è¦è®¤è¯ï¼š

- `/dashboard` - ä»ªè¡¨æ¿
- `/admin` - ç®¡ç†é¡µé¢
- `/profile` - ç”¨æˆ·èµ„æ–™

## ä½¿ç”¨æ–¹æ³•

### 1. åŸºæœ¬ä½¿ç”¨

ä¸­é—´ä»¶ä¼šè‡ªåŠ¨å¤„ç†è®¤è¯ï¼Œæ— éœ€é¢å¤–é…ç½®ï¼š

```typescript
// é¡µé¢ç»„ä»¶ä¸­è·å–ç”¨æˆ·ä¿¡æ¯
import { headers } from 'next/headers'

export default function Dashboard() {
  const headersList = headers()
  const userId = headersList.get('x-user-id')
  const isAuthenticated = headersList.get('x-authenticated')
  
  if (!isAuthenticated) {
    return <div>è¯·å…ˆç™»å½•</div>
  }
  
  return <div>æ¬¢è¿ï¼Œç”¨æˆ· {userId}</div>
}
```

### 2. è‡ªå®šä¹‰é…ç½®

```typescript
// lib/middleware-config.ts
import { getMiddlewareConfig } from './middleware-config'

// è·å–è‡ªå®šä¹‰é…ç½®
const customConfig = getMiddlewareConfig({
  enableLogging: true,
  redirectToLogin: true,
  protectedPaths: ['/dashboard', '/admin', '/profile', '/settings'],
  excludedPaths: ['/api', '/static', '/public']
})
```

### 3. API è·¯ç”±ä¸­ä½¿ç”¨

```typescript
// app/api/protected/route.ts
import { headers } from 'next/headers'
import { NextResponse } from 'next/server'

export async function GET() {
  const headersList = headers()
  const userId = headersList.get('x-user-id')
  
  if (!userId) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }
  
  return NextResponse.json({ 
    message: 'Protected data',
    userId 
  })
}
```

## è®¤è¯æµç¨‹

1. **è¯·æ±‚åˆ°è¾¾**: ä¸­é—´ä»¶æ‹¦æˆªæ‰€æœ‰åŒ¹é…çš„è¯·æ±‚
2. **æå–ä»¤ç‰Œ**: ä» cookie æˆ– header ä¸­æå–è®¤è¯ä»¤ç‰Œ
3. **éªŒè¯ä»¤ç‰Œ**: ä½¿ç”¨ Redis éªŒè¯ä»¤ç‰Œæœ‰æ•ˆæ€§
4. **æ³¨å…¥ä¿¡æ¯**: å°†ç”¨æˆ·ä¿¡æ¯æ³¨å…¥åˆ°è¯·æ±‚å¤´
5. **ç»§ç»­å¤„ç†**: è¯·æ±‚ç»§ç»­åˆ°é¡µé¢ç»„ä»¶æˆ– API è·¯ç”±

## é”™è¯¯å¤„ç†

### Redis è¿æ¥é”™è¯¯
- ä¸­é—´ä»¶ä¼šè®°å½•é”™è¯¯ä½†ä¸ä¸­æ–­è¯·æ±‚
- ç”Ÿäº§ç¯å¢ƒå»ºè®®ç¡®ä¿ Redis å¯ç”¨æ€§
- å¯é…ç½®é™çº§ç­–ç•¥

### ä»¤ç‰ŒéªŒè¯å¤±è´¥
- è®°å½•è­¦å‘Šæ—¥å¿—
- å¯é€‰æ‹©é‡å®šå‘åˆ°ç™»å½•é¡µ
- ç»§ç»­è¯·æ±‚è®©é¡µé¢ç»„ä»¶å¤„ç†

## æ€§èƒ½ä¼˜åŒ–

### ç¼“å­˜ç­–ç•¥
- å¯å¯ç”¨ä»¤ç‰Œç¼“å­˜å‡å°‘ Redis æŸ¥è¯¢
- é…ç½®ç¼“å­˜è¶…æ—¶æ—¶é—´
- æ”¯æŒç¼“å­˜å¤±æ•ˆç­–ç•¥

### è·¯å¾„åŒ¹é…ä¼˜åŒ–
- ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼é«˜æ•ˆåŒ¹é…
- æ’é™¤ä¸éœ€è¦è®¤è¯çš„è·¯å¾„
- å‡å°‘ä¸å¿…è¦çš„å¤„ç†

## å¼€å‘è°ƒè¯•

### å¯ç”¨è°ƒè¯•æ—¥å¿—

```bash
# è®¾ç½®ç¯å¢ƒå˜é‡
export MIDDLEWARE_LOG_LEVEL="debug"
export NODE_ENV="development"
```

### æŸ¥çœ‹æ—¥å¿—è¾“å‡º

```bash
# å¼€å‘ç¯å¢ƒ
npm run dev

# æŸ¥çœ‹ä¸­é—´ä»¶æ—¥å¿—
[Middleware:INFO] 2024-01-01T12:00:00.000Z - Processing request - {"method":"GET","pathname":"/dashboard","url":"http://localhost:3000/dashboard"}
[Middleware:INFO] 2024-01-01T12:00:00.001Z - User authenticated - {"userId":"user123","pathname":"/dashboard"}
```

## éƒ¨ç½²æ³¨æ„äº‹é¡¹

### Docker ç¯å¢ƒ
- ç¡®ä¿ Redis æœåŠ¡å¯ç”¨
- é…ç½®æ­£ç¡®çš„ç½‘ç»œè¿æ¥
- è®¾ç½®é€‚å½“çš„ç¯å¢ƒå˜é‡

### ç”Ÿäº§ç¯å¢ƒ
- ç¦ç”¨è¯¦ç»†æ—¥å¿—
- é…ç½®é”™è¯¯ç›‘æ§
- è®¾ç½®å¥åº·æ£€æŸ¥

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **Redis è¿æ¥å¤±è´¥**
   - æ£€æŸ¥ Redis æœåŠ¡çŠ¶æ€
   - éªŒè¯è¿æ¥å­—ç¬¦ä¸²
   - ç¡®è®¤ç½‘ç»œè¿é€šæ€§

2. **ä»¤ç‰ŒéªŒè¯å¤±è´¥**
   - æ£€æŸ¥ä»¤ç‰Œæ ¼å¼
   - éªŒè¯ Redis ä¸­çš„ä»¤ç‰Œ
   - ç¡®è®¤ JWT å¯†é’¥é…ç½®

3. **é‡å®šå‘å¾ªç¯**
   - æ£€æŸ¥ç™»å½•é¡µé¢è·¯å¾„
   - ç¡®è®¤æ’é™¤è·¯å¾„é…ç½®
   - éªŒè¯è®¤è¯é€»è¾‘

### è°ƒè¯•æŠ€å·§

1. å¯ç”¨è¯¦ç»†æ—¥å¿—
2. æ£€æŸ¥ç½‘ç»œè¯·æ±‚
3. éªŒè¯ç¯å¢ƒå˜é‡
4. æµ‹è¯• Redis è¿æ¥

## æ›´æ–°æ—¥å¿—

### v2.0.0
- é‡æ„é…ç½®ç³»ç»Ÿ
- å¢å¼ºé”™è¯¯å¤„ç†
- æ”¹è¿›æ—¥å¿—è®°å½•
- æ·»åŠ ç±»å‹å®‰å…¨

### v1.0.0
- åŸºç¡€è®¤è¯åŠŸèƒ½
- Cookie å’Œ Header æ”¯æŒ
- è·¯å¾„ä¿æŠ¤æœºåˆ¶ 